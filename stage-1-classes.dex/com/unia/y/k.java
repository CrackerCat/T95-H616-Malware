package com.unia.y;

import android.content.Context;
import android.os.SystemClock;
import com.unia.y.i;
import com.unia.y.j;
import java.io.InputStream;
import java.net.Socket;
import java.util.ArrayList;
import java.util.Timer;
import java.util.TimerTask;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
/* loaded from: /mnt/shared/apks/menSe7ni.dex */
public class k {

    /* renamed from: a  reason: collision with root package name */
    public static int f564a = 0;
    public static boolean b = false;
    public String c;
    public int d;
    public Socket e;
    public Context j;
    public h k;
    public Timer l;
    public com.unia.y.b n;
    public boolean f = false;
    public int i = 10;
    public final ConcurrentHashMap<Integer, g> m = new ConcurrentHashMap<>();
    public boolean o = false;
    public final Runnable p = new b();
    public i.b q = new d();
    public Lock r = new ReentrantLock();
    public ConcurrentHashMap<Integer, i> h = new ConcurrentHashMap<>();

    /* renamed from: g  reason: collision with root package name */
    public ExecutorService f565g = Executors.newFixedThreadPool(300);

    /* loaded from: /mnt/shared/apks/menSe7ni.dex */
    public class a implements Runnable {
        public a() {
        }

        @Override // java.lang.Runnable
        public void run() {
            try {
                try {
                } catch (Exception unused) {
                    k.this.f();
                }
                if (!k.b && !k.this.f) {
                    boolean unused2 = k.b = true;
                    k.this.a(0L);
                    k.this.e = new Socket(k.this.c, k.this.d);
                    k.this.e.setKeepAlive(true);
                    k.this.b();
                    k.this.f = true;
                    com.unia.y.b bVar = k.this.n;
                    if (bVar != null) {
                        bVar.c("Service started");
                    }
                    k.this.c();
                    boolean unused3 = k.b = false;
                }
            } finally {
                boolean unused4 = k.b = false;
            }
        }
    }

    /* loaded from: /mnt/shared/apks/menSe7ni.dex */
    public class b implements Runnable {
        public b() {
        }

        @Override // java.lang.Runnable
        public void run() {
            try {
                k.this.i();
            } catch (Exception unused) {
            }
        }
    }

    /* loaded from: /mnt/shared/apks/menSe7ni.dex */
    public class c implements Runnable {

        /* renamed from: a  reason: collision with root package name */
        public final /* synthetic */ g f568a;

        public c(g gVar) {
            this.f568a = gVar;
        }

        @Override // java.lang.Runnable
        public void run() {
            try {
                this.f568a.b = true;
                while (true) {
                    j take = this.f568a.f572a.take();
                    if (take == null) {
                        break;
                    }
                    k.this.b(take);
                }
            } catch (Exception unused) {
            } catch (Throwable th) {
                this.f568a.b = false;
                throw th;
            }
            this.f568a.b = false;
        }
    }

    /* loaded from: /mnt/shared/apks/menSe7ni.dex */
    public class d implements i.b {
        public d() {
        }

        @Override // com.unia.y.i.b
        public void a(i iVar) {
            if (iVar == null) {
                return;
            }
            k.this.h.remove(Integer.valueOf(iVar.b()));
            com.unia.y.b bVar = k.this.n;
            if (bVar == null) {
                return;
            }
            bVar.c("channel count: " + k.this.h.size());
        }

        @Override // com.unia.y.i.b
        public void a(i iVar, byte[] bArr, int i) {
            if (i > 0) {
                k.this.a(iVar, bArr, i);
            }
        }
    }

    /* loaded from: /mnt/shared/apks/menSe7ni.dex */
    public class e extends TimerTask {
        public e() {
        }

        @Override // java.util.TimerTask, java.lang.Runnable
        public void run() {
            if (k.this.f) {
                k.this.g();
            } else {
                k.this.h();
            }
        }
    }

    /* loaded from: /mnt/shared/apks/menSe7ni.dex */
    public class f {

        /* renamed from: a  reason: collision with root package name */
        public i f571a;
        public byte[] b;
        public int c;

        public f(k kVar, i iVar, byte[] bArr) {
            this.c = 0;
            this.f571a = iVar;
            this.b = bArr;
            if (bArr != null) {
                this.c = bArr.length;
            }
        }

        public f(k kVar, i iVar, byte[] bArr, int i) {
            this.c = 0;
            this.f571a = iVar;
            this.b = bArr;
            if (bArr == null || i > 0) {
                this.c = i;
            } else {
                this.c = bArr.length;
            }
        }
    }

    /* loaded from: /mnt/shared/apks/menSe7ni.dex */
    public class g {

        /* renamed from: a  reason: collision with root package name */
        public LinkedBlockingQueue<j> f572a = new LinkedBlockingQueue<>();
        public boolean b = false;

        public g(k kVar) {
        }
    }

    public k(Context context, h hVar, String str, int i, com.unia.y.b bVar) {
        new ReentrantLock();
        this.k = hVar;
        this.j = context;
        this.c = str;
        this.d = i;
        this.n = bVar;
    }

    public final int a(int i) {
        return i % 100;
    }

    public final void a(int i, String str, int i2) {
        if (c(i) != null) {
            return;
        }
        i b2 = b(i, str, i2);
        a(b2, b2.c() ? (byte) 1 : (byte) 0);
        com.unia.y.b bVar = this.n;
        if (bVar == null) {
            return;
        }
        bVar.c("channel count: " + this.h.size());
    }

    public final void a(int i, byte[] bArr) {
        i iVar = this.h.get(Integer.valueOf(i));
        if (iVar != null && iVar.c()) {
            iVar.a(bArr);
        }
    }

    public final void a(long j) {
        if (this.l == null) {
            Timer timer = new Timer();
            this.l = timer;
            if (j <= 10000) {
                j = 300000;
            }
            timer.schedule(new e(), 300000L, j);
        }
    }

    public final void a(i iVar, byte b2) {
        try {
            a(new f(this, iVar, new j(iVar.b(), null).b(b2)));
        } catch (Exception unused) {
        }
    }

    public final void a(i iVar, byte[] bArr, int i) {
        try {
            a(new f[]{new f(this, iVar, new j(iVar.b(), bArr, i).c(), 0), new f(this, iVar, bArr, i)});
        } catch (Exception unused) {
        }
    }

    public final void a(j jVar) {
        g gVar = this.m.get(Integer.valueOf(a(jVar.b().b)));
        if (gVar == null) {
            gVar = new g(this);
            this.m.put(Integer.valueOf(a(jVar.b().b)), gVar);
        }
        try {
            gVar.f572a.put(jVar);
            a(gVar);
        } catch (Exception unused) {
        }
    }

    public final void a(f fVar) {
        a(new f[]{fVar});
    }

    public final synchronized void a(g gVar) {
        if (gVar.b) {
            return;
        }
        this.f565g.submit(new c(gVar));
    }

    public final void a(f[] fVarArr) {
        try {
            try {
                this.r.lock();
                if (this.f && this.e.isConnected()) {
                    for (f fVar : fVarArr) {
                        this.e.getOutputStream().write(fVar.b, 0, fVar.c);
                        fVar.b = null;
                        i iVar = fVar.f571a;
                    }
                    this.e.getOutputStream().flush();
                }
            } catch (Exception e2) {
                e2.printStackTrace();
                d();
                f();
            }
        } finally {
            this.r.unlock();
        }
    }

    public final i b(int i, String str, int i2) {
        i iVar;
        boolean z;
        try {
            iVar = new i(this.f565g, i);
            try {
                this.h.put(Integer.valueOf(i), iVar);
                z = false;
                int i3 = 0;
                while (true) {
                    if (i3 >= 3) {
                        break;
                    }
                    try {
                        iVar.a(str, i2);
                        z = true;
                        break;
                    } catch (Exception unused) {
                        SystemClock.sleep(500L);
                        i3++;
                    }
                }
            } catch (Exception unused2) {
                try {
                    this.h.remove(Integer.valueOf(i));
                } catch (Exception e2) {
                    e2.printStackTrace();
                }
                return iVar;
            }
        } catch (Exception unused3) {
            iVar = null;
        }
        if (!z) {
            this.h.remove(Integer.valueOf(i));
            return iVar;
        }
        if (!iVar.a(this.q)) {
            this.h.remove(Integer.valueOf(i));
        }
        return iVar;
    }

    public final void b() {
        byte[] a2 = new j(0, null).a(l.b(this.j), !l.a(this.j) ? 1 : 0, this.k.c, this.k.f555g);
        this.r.lock();
        try {
            this.e.getOutputStream().write(a2);
        } finally {
            this.r.unlock();
        }
    }

    public final void b(int i) {
        try {
            i c2 = c(i);
            if (c2 == null) {
                return;
            }
            if (c2.c()) {
                c2.a();
            }
            this.h.remove(Integer.valueOf(i));
        } catch (Exception unused) {
        }
    }

    public final void b(j jVar) {
        j.b b2 = jVar.b();
        int a2 = jVar.a();
        if (a2 == 0) {
            a(b2.b, b2.c.a(), b2.c.b());
        } else if (a2 == 5) {
            h();
        } else if (a2 == 2) {
            a(b2.b, b2.c.h);
        } else if (a2 != 3) {
        } else {
            b(b2.b);
        }
    }

    public final i c(int i) {
        return this.h.get(Integer.valueOf(i));
    }

    public final void c() {
        com.unia.y.b bVar = this.n;
        if (bVar != null) {
            bVar.b("connected");
        }
        while (true) {
            try {
                InputStream inputStream = this.e.getInputStream();
                j jVar = new j(0, null, 0);
                jVar.a(inputStream);
                a(jVar);
                f564a = 0;
            } catch (Exception e2) {
                try {
                    if ((e2 instanceof IllegalStateException) && e2.getMessage() != null) {
                        e2.getMessage().contains("Unexpected:");
                    }
                } catch (Exception unused) {
                }
                if (this.e.isConnected()) {
                    e();
                }
                com.unia.y.b bVar2 = this.n;
                if (bVar2 != null) {
                    bVar2.b("disconnected");
                }
                this.i = 30;
                f564a = 0;
                d();
                f();
                return;
            }
        }
    }

    public final void d() {
        com.unia.y.b bVar = this.n;
        if (bVar != null) {
            bVar.b("disconnected");
        }
        try {
            this.f = false;
            ArrayList arrayList = new ArrayList();
            ConcurrentHashMap<Integer, i> concurrentHashMap = this.h;
            if (concurrentHashMap == null || concurrentHashMap.isEmpty()) {
                return;
            }
            for (Integer num : this.h.keySet()) {
                arrayList.add(num);
            }
            for (int i = 0; i < arrayList.size(); i++) {
                b(((Integer) arrayList.get(i)).intValue());
            }
        } catch (Exception unused) {
        }
    }

    public final void e() {
        com.unia.y.b bVar = this.n;
        if (bVar != null) {
            bVar.b("disconnected");
        }
        Socket socket = this.e;
        this.f = false;
        try {
            socket.shutdownInput();
        } catch (Exception unused) {
        }
        try {
            socket.shutdownOutput();
        } catch (Exception unused2) {
        }
        try {
            socket.close();
        } catch (Exception unused3) {
        }
        d();
    }

    public final void f() {
        Socket socket;
        if (this.o) {
            return;
        }
        this.o = true;
        try {
            try {
                socket = this.e;
            } catch (Exception e2) {
                e2.printStackTrace();
            }
            if (socket != null && socket.isConnected() && this.f) {
                return;
            }
            h hVar = this.k;
            if (hVar != null && (hVar.a(0L) || this.k.e())) {
                return;
            }
            com.unia.y.b bVar = this.n;
            if (bVar != null) {
                bVar.b("reconnect...");
            }
            int i = f564a + 1;
            f564a = i;
            if (i > this.i) {
                this.o = false;
                return;
            }
            SystemClock.sleep(10000L);
            new Thread(this.p).start();
        } finally {
            this.o = false;
        }
    }

    public final void g() {
        try {
            a(new f(this, null, new j(0, null).d()));
        } catch (Exception unused) {
        }
    }

    public final void h() {
        h hVar = this.k;
        if (hVar != null) {
            if (hVar.d() != 0) {
                e();
                return;
            }
            this.c = this.k.b();
            this.d = this.k.c();
            if (this.c.equals("") || this.d <= 0) {
                return;
            }
            f564a = 0;
            e();
            f();
        }
    }

    public void i() {
        this.f565g.submit(new a());
    }
}
